<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>智能单据识别系统</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#1E40AF',
            secondary: '#0EA5E9',
            success: '#10B981',
            warning: '#F59E0B',
            danger: '#EF4444',
            neutral: {
              50: '#F8FAFC',
              100: '#F1F5F9',
              200: '#E2E8F0',
              700: '#334155',
              800: '#1E293B',
              900: '#0F172A',
            }
          },
          fontFamily: {
            inter: ['Inter', 'system-ui', 'sans-serif'],
          },
        }
      }
    }
  </script>
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .step-active {
        @apply border-primary bg-primary text-white;
      }
      .step-done {
        @apply border-success bg-success text-white;
      }
      .step-pending {
        @apply border-neutral-300 bg-white text-neutral-500;
      }
      .upload-hover {
        @apply border-primary bg-blue-50;
      }
      .tab-active {
        @apply border-primary text-primary;
      }
      .tab-inactive {
        @apply border-transparent text-neutral-500 hover:text-neutral-700;
      }
    }
  </style>
</head>
<body class="bg-neutral-50 text-neutral-800 font-inter min-h-screen flex flex-col">
  <!-- 顶部导航栏 -->
  <header class="bg-white border-b border-neutral-200 sticky top-0 z-50 shadow-sm">
    <div class="container mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center space-x-3">
        <div class="bg-gradient-to-br from-primary to-secondary text-white p-2.5 rounded-lg shadow">
          <i class="fa fa-file-text-o text-xl"></i>
        </div>
        <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-primary to-secondary">智能单据识别系统</h1>
      </div>
      <div class="flex items-center space-x-6">
        <div class="hidden md:flex items-center space-x-1 text-sm text-neutral-600">
          <i class="fa fa-clock-o text-primary"></i>
          <span id="current-time" class="font-medium">2023-06-15 14:30:25</span>
        </div>
      </div>
    </div>
  </header>
  <div class="flex flex-1 overflow-hidden">
    <!-- 侧边栏导航 -->
    <aside class="w-16 md:w-64 bg-white border-r border-neutral-200 flex flex-col transition-all duration-300 z-40">
      <nav class="flex-1 py-6 overflow-y-auto">
        <ul>
          <li class="mb-1 relative">
            <a href="#" class="flex items-center px-4 py-3.5 text-primary bg-blue-50 rounded-r-lg transition-all">
              <i class="fa fa-file-image-o text-xl w-8 text-center"></i>
              <span class="hidden md:inline ml-3 font-medium">单据识别</span>
              <span class="absolute left-0 top-0 bottom-0 w-1 bg-primary rounded-r"></span>
            </a>
          </li>
          <li class="mb-1">
            <a href="history" class="flex items-center px-4 py-3.5 text-neutral-600 hover:text-primary hover:bg-blue-50 rounded-r-lg transition-all">
              <i class="fa fa-history text-xl w-8 text-center"></i>
              <span class="hidden md:inline ml-3">识别历史</span>
            </a>
          </li>
        </ul>
      </nav>
    </aside>
    <!-- 主内容区域 -->
    <main class="flex-1 overflow-y-auto bg-neutral-50 p-4 md:p-6">
      <div class="max-w-7xl mx-auto">
        <!-- 页面标题 -->
        <div class="mb-6">
          <h2 class="text-[clamp(1.2rem,2vw,1.6rem)] font-bold text-neutral-800 mb-1">单据识别</h2>
          <p class="text-neutral-600 text-sm mb-4">上传产品合格证等单据图片，系统将自动识别并提取关键信息</p>
        </div>
        <!-- 三列布局：上传区、预览区、结果区 -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <!-- 左侧：上传区域 -->
          <div class="md:col-span-2">
            <div class="bg-white rounded-xl p-5 shadow-sm hover:shadow-md transition-shadow h-full">
              <h3 class="text-base font-semibold mb-4 flex items-center">
                <i class="fa fa-cloud-upload text-primary mr-4"></i>上传图片
              </h3>
              <!-- 图片上传区域（包含预览容器） -->
              <div class="border-2 border-dashed border-neutral-300 rounded-lg p-5 text-center cursor-pointer hover:upload-hover transition-all min-h-[29rem] flex flex-col justify-center mb-5" id="uploadArea">
                <!-- 初始上传提示 -->
                <div id="uploadPrompt" class="flex flex-col items-center justify-center">
                  <i class="fa fa-picture-o text-4xl text-primary/70 mb-3"></i>
                  <h4 class="text-sm font-medium mb-1 text-neutral-800">拖拽图片到此处或点击上传</h4>
                  <p class="text-neutral-500 text-xs mb-3">支持 JPG、PNG 格式，文件大小不超过 5MB</p>
                  <button class="px-4 py-1.5 bg-primary hover:bg-primary/90 text-white rounded-lg text-xs transition-all mx-auto">
                    <i class="fa fa-upload mr-1"></i>选择图片
                  </button>
                </div>
                <!-- 图片预览容器（初始隐藏） -->
                <div id="previewContainer" class="hidden w-full h-full"></div>
              </div>
              <!-- 操作按钮 -->
              <div class="flex gap-2">
                <button class="flex-1 px-6 py-2.5 bg-neutral-100 hover:bg-neutral-200 text-neutral-800 rounded-lg text-sm transition-all" id="resetBtn" disabled>
                  <i class="fa fa-refresh mr-1"></i>重新选择
                </button>
                <button class="flex-1 px-6 py-2.5 bg-primary hover:bg-primary/90 text-white rounded-lg text-sm transition-all" id="recognizeBtn" disabled>
                  <i class="fa fa-magic mr-1"></i>开始识别
                </button>
              </div>
            </div>
          </div>
          <!-- 右侧：结果区域 -->
          <div class="md:col-span-1">
            <div class="bg-white rounded-xl p-5 shadow-sm h-full">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-base font-semibold flex items-center">
                  <i class="fa fa-list-alt text-primary mr-2"></i>识别结果
                </h3>
                <span id="statusTag" class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                  <i class="fa fa-clock-o mr-1"></i>等待图片上传
                </span>
              </div>

              <!-- 多结果切换标签 -->
              <div id="resultTabs" class="flex border-b border-neutral-200 mb-4 hidden">
                <!-- 动态生成的标签 -->
              </div>

              <!-- 结果容器 -->
              <div id="resultsContainer" class="space-y-3 text-sm">
                <!-- 初始结果表单 (单结果版本) -->
                <div class="result-form" data-index="0">
                  <!-- 产品名称 -->
                  <div>
                    <label class="block text-xs font-medium text-neutral-700 mb-0.5">产品名称</label>
                    <input type="text" id="nameResult_0" class="w-full border border-neutral-300 rounded-lg px-2.5 py-1.5 text-xs focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" value="-" disabled>
                  </div>
                  <!-- 型号 -->
                  <div>
                    <label class="block text-xs font-medium text-neutral-700 mb-0.5">型号</label>
                    <input type="text" id="modelResult_0" class="w-full border border-neutral-300 rounded-lg px-2.5 py-1.5 text-xs focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" value="-" disabled>
                  </div>
                  <!-- 规格 -->
                  <div>
                    <label class="block text-xs font-medium text-neutral-700 mb-0.5">规格</label>
                    <input type="text" id="specResult_0" class="w-full border border-neutral-300 rounded-lg px-2.5 py-1.5 text-xs focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" value="-" disabled>
                  </div>
                  <!-- 生产厂家 -->
                  <div>
                    <label class="block text-xs font-medium text-neutral-700 mb-0.5">生产厂家</label>
                    <input type="text" id="manufacturerResult_0" class="w-full border border-neutral-300 rounded-lg px-2.5 py-1.5 text-xs focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" value="-" disabled>
                  </div>
                  <!-- 生产日期 -->
                  <div>
                    <label class="block text-xs font-medium text-neutral-700 mb-0.5">生产日期</label>
                    <input type="date" id="productionDateResult_0" class="w-full border border-neutral-300 rounded-lg px-2.5 py-1.5 text-xs focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" disabled>
                  </div>
                  <!-- 出厂日期 -->
                  <div>
                    <label class="block text-xs font-medium text-neutral-700 mb-0.5">出厂日期</label>
                    <input type="date" id="shipmentDateResult_0" class="w-full border border-neutral-300 rounded-lg px-2.5 py-1.5 text-xs focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" disabled>
                  </div>
                  <!-- 批号 -->
                  <div>
                    <label class="block text-xs font-medium text-neutral-700 mb-0.5">批号</label>
                    <input type="text" id="batchNumberResult_0" class="w-full border border-neutral-300 rounded-lg px-2.5 py-1.5 text-xs focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" value="-" disabled>
                  </div>
                  <!-- 备注信息 -->
                  <div>
                    <label class="block text-xs font-medium text-neutral-700 mb-0.5">备注</label>
                    <textarea id="remarkResult_0" class="w-full border border-neutral-300 rounded-lg px-2.5 py-1.5 text-xs focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" rows="1" disabled placeholder="识别过程自动生成的备注信息"></textarea>
                  </div>
                </div>
              </div>

              <!-- 操作按钮 -->
              <div class="flex gap-2 mt-5 justify-end">
                <button class="px-6 py-2.5 bg-neutral-100 hover:bg-neutral-200 text-neutral-800 rounded-lg text-sm transition-all" id="reRecognizeBtn" disabled>
                  <i class="fa fa-refresh mr-1"></i>重新识别
                </button>
                <button class="px-6 py-2.5 bg-primary hover:bg-primary/90 text-white rounded-lg text-sm transition-all" id="confirmBtn" disabled>
                  <i class="fa fa-check mr-1"></i>保存全部
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
  <!-- 通知提示组件 -->
  <div id="notification" class="fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300 z-50 flex items-center">
    <i id="notificationIcon" class="mr-2 text-xl"></i>
    <span id="notificationText"></span>
  </div>
  <script>
    // 等待DOM加载完成后执行
    document.addEventListener('DOMContentLoaded', function() {
      // 初始化变量存储多结果数据
      let currentResults = [];

      // 通知提示功能
      function showNotification(message, type = 'success') {
        const notification = document.getElementById('notification');
        const icon = document.getElementById('notificationIcon');
        const text = document.getElementById('notificationText');
        text.textContent = message;
        if (type === 'success') {
          notification.className = 'fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg transform translate-x-full bg-green-500 text-white transition-transform duration-300 z-50 flex items-center';
          icon.className = 'fa fa-check-circle mr-2 text-xl';
        } else if (type === 'error') {
          notification.className = 'fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg transform translate-x-full bg-red-500 text-white transition-transform duration-300 z-50 flex items-center';
          icon.className = 'fa fa-exclamation-circle mr-2 text-xl';
        } else if (type === 'info') {
          notification.className = 'fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg transform translate-x-full bg-blue-500 text-white transition-transform duration-300 z-50 flex items-center';
          icon.className = 'fa fa-info-circle mr-2 text-xl';
        }
        setTimeout(() => notification.classList.remove('translate-x-full'), 100);
        setTimeout(() => notification.classList.add('translate-x-full'), 3000);
      }

      // 更新当前时间
      function updateCurrentTime() {
        const now = new Date();
        const options = {
          year: 'numeric', month: '2-digit', day: '2-digit',
          hour: '2-digit', minute: '2-digit', second: '2-digit'
        };
        document.getElementById('current-time').textContent = now.toLocaleString('zh-CN', options);
      }
      updateCurrentTime();
      setInterval(updateCurrentTime, 1000);

      // DOM元素获取（确保DOM加载后获取）
      const uploadArea = document.getElementById('uploadArea');
      const uploadPrompt = document.getElementById('uploadPrompt');
      const previewContainer = document.getElementById('previewContainer');
      const recognizeBtn = document.getElementById('recognizeBtn');
      const resetBtn = document.getElementById('resetBtn');
      const reRecognizeBtn = document.getElementById('reRecognizeBtn');
      const confirmBtn = document.getElementById('confirmBtn');
      const statusTag = document.getElementById('statusTag');
      const resultTabs = document.getElementById('resultTabs');
      const resultsContainer = document.getElementById('resultsContainer');

      // 创建隐藏的文件输入框
      const fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.accept = 'image/*';
      fileInput.className = 'hidden';
      document.body.appendChild(fileInput);

      // 上传区域点击事件
      uploadArea.addEventListener('click', (e) => {
        // 点击预览区域的删除按钮时不触发文件选择
        if (!e.target.closest('.preview-actions')) {
          fileInput.click();
        }
      });

      // 文件选择处理
      fileInput.addEventListener('change', function(e) {
        if (this.files && this.files[0]) {
          handleFile(this.files[0]);
        }
      });

      // 拖拽上传
      uploadArea.addEventListener('dragover', e => {
        e.preventDefault();
        uploadArea.classList.add('upload-hover');
      });

      uploadArea.addEventListener('dragleave', e => {
        e.preventDefault();
        uploadArea.classList.remove('upload-hover');
      });

      uploadArea.addEventListener('drop', e => {
        e.preventDefault();
        uploadArea.classList.remove('upload-hover');
        if (e.dataTransfer.files && e.dataTransfer.files[0]) {
          handleFile(e.dataTransfer.files[0]);
        }
      });

      // 处理文件上传和预览
      function handleFile(file) {
        // 验证文件类型
        if (!file.type.match('image.*')) {
          showNotification('请选择图片文件！', 'error');
          return;
        }
        // 验证文件大小
        if (file.size > 5 * 1024 * 1024) {
          showNotification('文件大小不能超过5MB！', 'error');
          return;
        }
        // 创建FormData上传文件到后端
        const formData = new FormData();
        formData.append('file', file);
        fetch('/upload', {
          method: 'POST',
          body: formData
        })
        .then(response => {
          if (!response.ok) {
            throw new Error(`上传失败：${response.statusText}`);
          }
          return response.json();
        })
        .then(data => {
          if (data.status === 'success') {
            // 显示图片预览（隐藏上传提示）
            const reader = new FileReader();
            reader.onload = e => {
              // 隐藏上传提示，显示预览
              uploadPrompt.classList.add('hidden');
              previewContainer.classList.remove('hidden');
              previewContainer.innerHTML = `
                <div class="relative w-full h-full flex items-center justify-center">
                  <img src="${e.target.result}" alt="预览图片" class="max-w-full max-h-full object-contain">
                  <div class="preview-actions absolute top-1 right-1 flex gap-1">
                    <button class="w-6 h-6 rounded-full bg-black/50 text-white flex items-center justify-center hover:bg-black/70" onclick="removePreview()">
                      <i class="fa fa-times text-xs"></i>
                    </button>
                  </div>
                  <input type="hidden" id="currentFilename" value="${data.filename}">
                </div>
              `;
              // 更新按钮状态
              recognizeBtn.disabled = false;
              resetBtn.disabled = false;
              statusTag.innerHTML = '<i class="fa fa-arrow-right mr-1"></i> 点击开始识别';
              statusTag.className = 'inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-primary/10 text-primary';
              showNotification('图片上传成功', 'success');
            };
            reader.readAsDataURL(file);
          } else {
            showNotification(data.message, 'error');
          }
        })
        .catch(error => {
          showNotification('上传失败，请重试', 'error');
          console.error('Upload error:', error);
        });
      }

      // 移除预览（重置上传区域）
      window.removePreview = function() {
        previewContainer.classList.add('hidden');
        uploadPrompt.classList.remove('hidden');
        previewContainer.innerHTML = '';
        // 重置按钮状态
        recognizeBtn.disabled = true;
        resetBtn.disabled = true;
        reRecognizeBtn.disabled = true;
        confirmBtn.disabled = true;
        statusTag.innerHTML = '<i class="fa fa-clock-o mr-1"></i>等待图片上传';
        statusTag.className = 'inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800';
        // 重置多结果状态
        currentResults = [];
        resultTabs.innerHTML = '';
        resultTabs.classList.add('hidden');
        // 清空结果容器，显示初始表单
        resultsContainer.innerHTML = `
          <div class="result-form" data-index="0">
            <div>
              <label class="block text-xs font-medium text-neutral-700 mb-0.5">产品名称</label>
              <input type="text" id="nameResult_0" class="w-full border border-neutral-300 rounded-lg px-2.5 py-1.5 text-xs focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" value="-" disabled>
            </div>
            <div>
              <label class="block text-xs font-medium text-neutral-700 mb-0.5">型号</label>
              <input type="text" id="modelResult_0" class="w-full border border-neutral-300 rounded-lg px-2.5 py-1.5 text-xs focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" value="-" disabled>
            </div>
            <div>
              <label class="block text-xs font-medium text-neutral-700 mb-0.5">规格</label>
              <input type="text" id="specResult_0" class="w-full border border-neutral-300 rounded-lg px-2.5 py-1.5 text-xs focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" value="-" disabled>
            </div>
            <div>
              <label class="block text-xs font-medium text-neutral-700 mb-0.5">生产厂家</label>
              <input type="text" id="manufacturerResult_0" class="w-full border border-neutral-300 rounded-lg px-2.5 py-1.5 text-xs focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" value="-" disabled>
            </div>
            <div>
              <label class="block text-xs font-medium text-neutral-700 mb-0.5">生产日期</label>
              <input type="date" id="productionDateResult_0" class="w-full border border-neutral-300 rounded-lg px-2.5 py-1.5 text-xs focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" disabled>
            </div>
            <div>
              <label class="block text-xs font-medium text-neutral-700 mb-0.5">出厂日期</label>
              <input type="date" id="shipmentDateResult_0" class="w-full border border-neutral-300 rounded-lg px-2.5 py-1.5 text-xs focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" disabled>
            </div>
            <div>
              <label class="block text-xs font-medium text-neutral-700 mb-0.5">批号</label>
              <input type="text" id="batchNumberResult_0" class="w-full border border-neutral-300 rounded-lg px-2.5 py-1.5 text-xs focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" value="-" disabled>
            </div>
            <div>
              <label class="block text-xs font-medium text-neutral-700 mb-0.5">备注</label>
              <textarea id="remarkResult_0" class="w-full border border-neutral-300 rounded-lg px-2.5 py-1.5 text-xs focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" rows="1" disabled placeholder="识别过程自动生成的备注信息"></textarea>
            </div>
          </div>
        `;
      };

      // 重置按钮事件
      resetBtn.addEventListener('click', removePreview);

      // 显示指定索引的结果
      function showResultTab(index) {
        resultsContainer.innerHTML = '';

        // 创建新的结果表单
        const resultForm = document.createElement('div');
        resultForm.className = 'result-form';
        resultForm.dataset.index = index;

        // 获取当前结果数据
        const result = currentResults[index] || {};

        // 生成表单内容
        resultForm.innerHTML = `
          <div>
            <label class="block text-xs font-medium text-neutral-700 mb-0.5">产品名称</label>
            <input type="text" id="nameResult_${index}" class="w-full border border-neutral-300 rounded-lg px-2.5 py-1.5 text-xs focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" value="${result.nameResult || '-'}" ${result ? '' : 'disabled'}>
          </div>
          <div>
            <label class="block text-xs font-medium text-neutral-700 mb-0.5">型号</label>
            <input type="text" id="modelResult_${index}" class="w-full border border-neutral-300 rounded-lg px-2.5 py-1.5 text-xs focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" value="${result.modelResult || '-'}" ${result ? '' : 'disabled'}>
          </div>
          <div>
            <label class="block text-xs font-medium text-neutral-700 mb-0.5">规格</label>
            <input type="text" id="specResult_${index}" class="w-full border border-neutral-300 rounded-lg px-2.5 py-1.5 text-xs focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" value="${result.specResult || '-'}" ${result ? '' : 'disabled'}>
          </div>
          <div>
            <label class="block text-xs font-medium text-neutral-700 mb-0.5">生产厂家</label>
            <input type="text" id="manufacturerResult_${index}" class="w-full border border-neutral-300 rounded-lg px-2.5 py-1.5 text-xs focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" value="${result.manufacturerResult || '-'}" ${result ? '' : 'disabled'}>
          </div>
          <div>
            <label class="block text-xs font-medium text-neutral-700 mb-0.5">生产日期</label>
            <input type="date" id="productionDateResult_${index}" class="w-full border border-neutral-300 rounded-lg px-2.5 py-1.5 text-xs focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" value="${result.productionDateResult || ''}" ${result ? '' : 'disabled'}>
          </div>
          <div>
            <label class="block text-xs font-medium text-neutral-700 mb-0.5">出厂日期</label>
            <input type="date" id="shipmentDateResult_${index}" class="w-full border border-neutral-300 rounded-lg px-2.5 py-1.5 text-xs focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" value="${result.shipmentDateResult || ''}" ${result ? '' : 'disabled'}>
          </div>
          <div>
            <label class="block text-xs font-medium text-neutral-700 mb-0.5">批号</label>
            <input type="text" id="batchNumberResult_${index}" class="w-full border border-neutral-300 rounded-lg px-2.5 py-1.5 text-xs focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" value="${result.batchNumberResult || '-'}" ${result ? '' : 'disabled'}>
          </div>
          <div>
            <label class="block text-xs font-medium text-neutral-700 mb-0.5">备注</label>
            <textarea id="remarkResult_${index}" class="w-full border border-neutral-300 rounded-lg px-2.5 py-1.5 text-xs focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" rows="1" ${result ? '' : 'disabled'}>${result.remarkResult || ''}</textarea>
          </div>
        `;

        resultsContainer.appendChild(resultForm);

        // 更新标签选中状态
        const tabs = document.querySelectorAll('#resultTabs button');
        tabs.forEach((tab, i) => {
          if (i === index) {
            tab.className = 'px-3 py-1 text-xs font-medium border-b-2 border-primary text-primary transition-colors';
          } else {
            tab.className = 'px-3 py-1 text-xs font-medium border-b-2 border-transparent text-neutral-500 hover:text-neutral-700 transition-colors';
          }
        });
      }

      // 识别按钮点击事件
      recognizeBtn.addEventListener('click', function() {
        this.disabled = true;
        this.innerHTML = '<i class="fa fa-spinner fa-spin mr-1"></i>识别中...';
        statusTag.innerHTML = '<i class="fa fa-spinner fa-spin mr-1"></i> 识别处理中';
        statusTag.className = 'inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800';

        // 获取上传的文件名
        const filename = document.getElementById('currentFilename')?.value;
        if (!filename) {
          showNotification('未找到图片，请重新上传', 'error');
          this.innerHTML = '<i class="fa fa-magic mr-1"></i>开始识别';
          this.disabled = false;
          return;
        }

        // 调用后端识别接口
        fetch('/recognize', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ filename: filename })
        })
        .then(response => {
          if (!response.ok) {
            throw new Error(`识别失败：${response.statusText}`);
          }
          return response.json();
        })
        .then(data => {
          if (data.status === 'success') {
            // 存储所有结果
            currentResults = Array.isArray(data.result) ? data.result : [data.result];

            // 显示标签切换（如果有多个结果）
            resultTabs.innerHTML = '';

            if (currentResults.length > 1) {
              resultTabs.classList.remove('hidden');
              currentResults.forEach((_, index) => {
                const tab = document.createElement('button');
                tab.className = `px-3 py-1 text-xs font-medium border-b-2 transition-colors ${index === 0 ? 'border-primary text-primary' : 'border-transparent text-neutral-500 hover:text-neutral-700'}`;
                tab.textContent = `单据 ${index + 1}`;
                tab.addEventListener('click', () => showResultTab(index));
                resultTabs.appendChild(tab);
              });
            } else {
              resultTabs.classList.add('hidden');
            }

            // 显示第一个结果
            showResultTab(0);

            // 更新状态
            this.innerHTML = '<i class="fa fa-magic mr-1"></i>开始识别';
            statusTag.innerHTML = `<i class="fa fa-check-circle mr-1"></i> 识别完成，共${currentResults.length}个单据`;
            statusTag.className = 'inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800';
            reRecognizeBtn.disabled = false;
            confirmBtn.disabled = false;
            showNotification(`识别完成，共发现${currentResults.length}个单据，可编辑并保存结果`, 'success');
          } else {
            showNotification(data.message, 'error');
            this.innerHTML = '<i class="fa fa-magic mr-1"></i>开始识别';
            this.disabled = false;
          }
        })
        .catch(error => {
          showNotification('识别失败，请重试', 'error');
          this.innerHTML = '<i class="fa fa-magic mr-1"></i>开始识别';
          this.disabled = false;
          console.error('Recognition error:', error);
        });
      });

      // 重新识别按钮事件（复用识别逻辑）
      reRecognizeBtn.addEventListener('click', function() {
        recognizeBtn.click();
      });

      // 保存按钮点击事件
      confirmBtn.addEventListener('click', function() {
        this.disabled = true;
        statusTag.innerHTML = '<i class="fa fa-spinner fa-spin mr-1"></i> 保存中...';
        statusTag.className = 'inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800';

        // 收集所有表单数据
        const allResults = [];
        currentResults.forEach((_, index) => {
          const formData = {
            nameResult: document.getElementById(`nameResult_${index}`).value,
            modelResult: document.getElementById(`modelResult_${index}`).value,
            specResult: document.getElementById(`specResult_${index}`).value,
            manufacturerResult: document.getElementById(`manufacturerResult_${index}`).value,
            productionDateResult: document.getElementById(`productionDateResult_${index}`).value,
            shipmentDateResult: document.getElementById(`shipmentDateResult_${index}`).value,
            batchNumberResult: document.getElementById(`batchNumberResult_${index}`).value,
            remarkResult: document.getElementById(`remarkResult_${index}`).value
          };
          allResults.push(formData);
        });

        // 调用后端保存接口
        fetch('/save', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(allResults)
        })
        .then(response => {
          if (!response.ok) {
            throw new Error(`保存失败：${response.statusText}`);
          }
          return response.json();
        })
        .then(data => {
          if (data.status === 'success') {
            statusTag.innerHTML = '<i class="fa fa-check-circle mr-1"></i> 已保存';
            statusTag.className = 'inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800';
            showNotification(`成功保存${allResults.length}条单据信息到识别历史`, 'success');
          } else {
            showNotification(data.message, 'error');
          }
          this.disabled = false;
        })
        .catch(error => {
          showNotification('保存失败，请重试', 'error');
          this.disabled = false;
          console.error('Save error:', error);
        });
      });
    });
  </script>
</body>
</html>